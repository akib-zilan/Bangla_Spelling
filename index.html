<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>বাংলা বানান অনুশীলন</title>

  <!-- Tailwind CDN (play-cdn for single file) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

  <style>
    :root { --glass-bg: rgba(255,255,255,0.04); }
    html,body{height:100%}
    body{
      font-family: 'Hind Siliguri', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#0f172a 0%, #020617 100%);
      color: #e6eef8;
    }

    /* Glassmorphism card */
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      backdrop-filter: blur(8px) saturate(120%);
      border: 1px solid rgba(255,255,255,0.06);
    }

    /* Smooth transitions */
    .btn-anim{transition:all .18s ease}
    .word-btn-anim{transition:transform .12s ease, box-shadow .12s ease}

  </style>
</head>
<body class="p-6">
  <div class="max-w-6xl mx-auto">
    <header class="mb-6">
      <div class="glass rounded-2xl p-4 flex items-center justify-between">
        <h1 class="text-2xl font-semibold">বাংলা বানান অনুশীলন</h1>
        <div class="flex items-center gap-4">
          <div id="userScore" class="text-center">
            <div class="text-xs text-gray-300">Score</div>
            <div class="text-xl font-bold">0</div>
          </div>
          <button id="resetBtn" class="btn-anim px-4 py-2 rounded-lg glass hover:scale-105">অগ্রগতি রিসেট করুন</button>
        </div>
      </div>
    </header>

    <main>
      <!-- Main Menu -->
      <section id="mainMenu" class="glass rounded-3xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-xl font-semibold">ব্লক সমূহ</h2>
            <p class="text-sm text-gray-300">মাস্টার তালিকা ব্লক প্রতি ৪০ শব্দে ভাগ করা হয়</p>
          </div>
          <div class="flex gap-3">
            <button id="addWordBtn" class="btn-anim px-4 py-2 rounded-lg glass hover:scale-105"><i class="fa fa-plus mr-2"></i> নতুন শব্দ যোগ করুন</button>
          </div>
        </div>

        <div id="blocksGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>

        <div id="specialDecks" class="mt-6">
          <h3 class="text-lg font-medium mb-2">বিশেষ ডেকস (Slabs & Bars)</h3>
          <div id="slabsBarsList" class="flex gap-3 flex-wrap"></div>
        </div>
      </section>

      <!-- Practice Screen (hidden default) -->
      <section id="practiceScreen" class="glass rounded-3xl p-6 mt-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 id="practiceTitle" class="text-xl font-semibold">ব্লক 1</h2>
            <div class="text-sm text-gray-300">Score: <span id="blockScore">0</span> • Progress: <span id="progressText">0/0</span></div>
          </div>
          <div class="flex items-center gap-3">
            <button id="backToMenu" class="btn-anim px-4 py-2 rounded-lg glass hover:scale-105"><i class="fa fa-arrow-left mr-2"></i> মেনু</button>
          </div>
        </div>

        <div class="mb-4">
          <div class="w-full bg-gray-800 rounded-full h-3 overflow-hidden">
            <div id="progressBar" class="h-3 rounded-full" style="width:0%; background: linear-gradient(90deg,#10b981,#06b6d4);"></div>
          </div>
        </div>

        <div class="flex flex-col md:flex-row gap-6 items-start">
          <div class="flex-1">
            <div class="text-6xl font-bold mb-4" id="wordDisplay">—</div>
            <div class="flex gap-3 mb-3">
              <button id="speakBtn" class="btn-anim px-4 py-2 rounded-lg glass hover:scale-105"><i class="fa fa-volume-up mr-2"></i> বল</button>
              <button id="skipBtn" class="btn-anim px-4 py-2 rounded-lg glass hover:scale-105">পাশ কাটুন</button>
            </div>

            <div>
              <input id="answerInput" autocomplete="off" class="w-full p-3 rounded-lg glass text-lg" placeholder="এখানে বানান লিখুন" />
            </div>

            <div id="feedback" class="mt-4 text-lg min-h-[56px]"></div>
          </div>

          <div class="w-80">
            <div class="glass rounded-xl p-4">
              <h4 class="font-medium mb-2">শব্দ বিবরণ</h4>
              <div class="text-sm text-gray-300 mb-4">এই কার্ড থেকে আপনি শব্দ মুছতে এবং প্র্যাকটিস তালিকায় যোগ করতে পারবেন।</div>
              <div class="flex flex-col gap-2">
                <button id="addToPractice" class="btn-anim px-3 py-2 rounded-lg glass hover:scale-105">অনুশীলন করুন</button>
                <button id="deleteWordBtn" class="btn-anim px-3 py-2 rounded-lg glass hover:scale-105">শব্দ মুছুন</button>
              </div>
            </div>

            <div class="glass rounded-xl p-4 mt-4">
              <h4 class="font-medium mb-2">পরিসংখ্যান</h4>
              <div class="text-sm text-gray-300">মোট উত্তর: <span id="totalAnswered">0</span></div>
              <div class="text-sm text-gray-300">সঠিক: <span id="totalCorrect">0</span></div>
              <div class="text-sm text-gray-300">ভুল: <span id="totalWrong">0</span></div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Hidden area for messages -->
  <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2"></div>

  <!-- The app expects a separate bengali_words.js which defines `words` array. If not present, a small fallback will be used. -->

  <script>
  // -------------------------------
  // Configuration & Globals
  // -------------------------------
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAKb836EZeSOoawW9gmQ_oQuTbjuvQbBLg",
    authDomain: "bengali-spelling.firebaseapp.com",
    projectId: "bengali-spelling",
    storageBucket: "bengali-spelling.firebasestorage.app",
    messagingSenderId: "402411944079",
    appId: "1:402411944079:web:211135597c0d5dab70d8fa",
    measurementId: "G-NZ03QPZYZK"
  };

  // Internal app state
  let MASTER_WORDS = []; // normalized [{word: 'বাংলা', id: <uuid>}, ...]
  let blocks = []; // array of blocks (each block: {name, words: [...]})
  let currentBlock = null;
  let currentIndex = 0;
  let userState = {
    uid: null,
    totalPoints: 0,
    deletedWords: [],
    slabs: {}, // { slabName: [wordIds] }
    bars: {}, // { barName: [wordIds] }
    practiceLists: {}, // custom practice decks
    stats: { answered:0, correct:0, wrong:0 }
  };

  // Utilities
  function uidShort(){return Math.random().toString(36).slice(2,9)}
  function makeId(){ return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,6)}

  function showToast(msg, kind='info'){
    const el = document.createElement('div')
    el.className = 'glass inline-block px-4 py-2 rounded-lg mr-2 text-sm'
    el.textContent = msg
    document.getElementById('toast').appendChild(el)
    setTimeout(()=> el.remove(), 3000)
  }

  // -------------------------------
  // Data normalization (Core Requirement)
  // -------------------------------
  function normalizeWords(raw){
    // raw may be undefined, array of strings, or array of objects (with word key or other)
    if(!Array.isArray(raw)) return []
    return raw.map(item => {
      if(typeof item === 'string') return { word: item, id: makeId() }
      if(typeof item === 'object' && item !== null){
        if(item.word && typeof item.word === 'string') return { ...item, id: item.id || makeId() }
        // If object with unknown shape, try to stringify
        if(item.hasOwnProperty('label')) return { word: String(item.label), id: item.id || makeId() }
        // fallback
        return { word: String(Object.values(item)[0]||''), id: item.id || makeId() }
      }
      return { word: String(item), id: makeId() }
    }).filter(x => x.word && x.word.trim().length)
  }

  // -------------------------------
  // Words loading (attempt to read external bengali_words.js)
  // -------------------------------
  (function loadExternalWords(){
    // We'll try to load bengali_words.js by creating a script tag. If it doesn't define `words`, we fallback.
    const s = document.createElement('script')
    s.src = 'bengali_words.js'
    s.onload = () => {
      console.log('bengali_words.js loaded:', typeof words !== 'undefined')
      if(typeof words !== 'undefined') {
        MASTER_WORDS = normalizeWords(words)
        initApp()
      } else {
        fallback()
      }
    }
    s.onerror = ()=> fallback()
    document.head.appendChild(s)

    function fallback(){
      console.warn('bengali_words.js not found or bad format — using small fallback list.')
      const fallbackList = ['বাংলা','অনুশীলন','শব্দ','অভ্যাস','শিক্ষা','বিদ্যা','বিদ্যালয়','ভালবাসা','বন্ধু','পরীক্ষা']
      MASTER_WORDS = normalizeWords(fallbackList)
      initApp()
    }
  })();

  // -------------------------------
  // Build blocks of 40 words
  // -------------------------------
  function buildBlocks(){
    blocks = []
    const filtered = MASTER_WORDS.filter(w => !userState.deletedWords.includes(w.id))
    for(let i=0;i<filtered.length;i+=40){
      const slice = filtered.slice(i,i+40)
      blocks.push({ name: `ব্লক ${Math.floor(i/40)+1}`, words: slice })
    }

    // Add slabs & bars as special decks
    // slabs and bars are shown separately
  }

  // -------------------------------
  // Firebase init & persistence
  // -------------------------------
  let firebaseApp, firestore, auth
  async function initFirebase(){
    try{
      // load firebase scripts dynamically (v9 compat CDN)
      await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js')
      await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js')
      await loadScript('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js')

      firebaseApp = firebase.initializeApp(FIREBASE_CONFIG)
      auth = firebase.auth()
      firestore = firebase.firestore()

      await auth.signInAnonymously()
      userState.uid = auth.currentUser.uid
      console.log('Signed in anonymously:', userState.uid)

      // load user progress from firestore
      const docRef = firestore.collection('users').doc(userState.uid)
      const doc = await docRef.get()
      if(doc.exists){
        const data = doc.data()
        Object.assign(userState, data)
        console.log('Loaded user state', userState)
      } else {
        await docRef.set(userState)
      }

    }catch(e){
      console.warn('Firebase init failed:', e)
      showToast('Firebase init failed — progress will not be saved.','error')
    }
  }

  function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s = document.createElement('script')
      s.src = src
      s.onload = resolve
      s.onerror = reject
      document.head.appendChild(s)
    })
  }

  async function saveUserState(){
    if(!firestore || !userState.uid) return
    try{
      await firestore.collection('users').doc(userState.uid).set(userState)
    }catch(e){ console.warn('Save failed', e) }
  }

  // -------------------------------
  // UI Rendering
  // -------------------------------
  function renderBlocksGrid(){
    const container = document.getElementById('blocksGrid')
    container.innerHTML = ''
    blocks.forEach((b, idx) => {
      const card = document.createElement('div')
      card.className = 'glass p-4 rounded-xl cursor-pointer word-btn-anim hover:scale-105'
      card.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <div class="font-semibold">${b.name}</div>
            <div class="text-sm text-gray-300">শব্দ: ${b.words.length}</div>
          </div>
          <div class="text-3xl">📚</div>
        </div>
      `
      card.onclick = ()=> openBlock(idx)
      container.appendChild(card)
    })

    // Update score display
    document.getElementById('userScore').querySelector('.text-xl').textContent = userState.totalPoints || 0
  }

  function renderSpecialDecks(){
    const el = document.getElementById('slabsBarsList')
    el.innerHTML = ''

    // Slabs
    for(const [slabName, ids] of Object.entries(userState.slabs||{})){
      const btn = document.createElement('button')
      btn.className = 'glass px-3 py-2 rounded-lg btn-anim'
      btn.textContent = `${slabName} (${ids.length})`
      btn.onclick = () => openCustomDeck(slabName,'slab')
      el.appendChild(btn)
    }

    for(const [barName, ids] of Object.entries(userState.bars||{})){
      const btn = document.createElement('button')
      btn.className = 'glass px-3 py-2 rounded-lg btn-anim'
      btn.textContent = `${barName} (${ids.length})`
      btn.onclick = () => openCustomDeck(barName,'bar')
      el.appendChild(btn)
    }
  }

  // -------------------------------
  // Navigation & Practice logic
  // -------------------------------
  function openBlock(idx){
    currentBlock = { type: 'block', index: idx, name: blocks[idx].name, words: blocks[idx].words.slice() }
    startPractice()
  }

  function openCustomDeck(name, kind){
    // build words from ids
    const ids = (kind==='slab') ? (userState.slabs[name]||[]) : (userState.bars[name]||[])
    const words = MASTER_WORDS.filter(w=> ids.includes(w.id))
    currentBlock = { type: kind, name, words }
    startPractice()
  }

  function startPractice(){
    if(!currentBlock || !currentBlock.words.length){ showToast('শূন্য ডেক (empty deck)'); return }
    currentIndex = 0
    document.getElementById('mainMenu').classList.add('hidden')
    document.getElementById('practiceScreen').classList.remove('hidden')
    updatePracticeUI()
  }

  function updatePracticeUI(){
    const total = currentBlock.words.length
    const current = Math.min(currentIndex, total-1)
    const wobj = currentBlock.words[current]
    document.getElementById('practiceTitle').textContent = currentBlock.name
    document.getElementById('blockScore').textContent = userState.totalPoints || 0
    document.getElementById('progressText').textContent = `${current+1}/${total}`
    const pct = Math.round(((current+1)/total)*100)
    document.getElementById('progressBar').style.width = pct + '%'
    document.getElementById('wordDisplay').textContent = '\u25CB' // don't show the word initially — we want the user to type
    document.getElementById('answerInput').value = ''
    document.getElementById('answerInput').focus()
    document.getElementById('feedback').innerHTML = ''
  }

  function revealCurrentWord(){
    const wobj = currentBlock.words[currentIndex]
    if(!wobj) return ''
    return wobj.word
  }

  async function handleAnswer(){
    const userText = document.getElementById('answerInput').value.trim()
    const correct = revealCurrentWord()
    userState.stats.answered++
    if(userText === correct){
      userState.stats.correct++
      userState.totalPoints = (userState.totalPoints || 0) + 1
      showFeedback(true, 'সঠিক!')
      // after correct, offer add to practice or delete. keep word in flow for next.
      // No change to slabs/bars on correct; if word existed in slab/bar we can consider removing it (optional)
      await saveUserState()
      setTimeout(()=> moveNext(true), 900)
    } else {
      userState.stats.wrong++
      showFeedback(false, `সঠিক বানান: ${correct}`)
      // Add to slab
      const slabName = `Slab ${new Date().toISOString().slice(0,10)}`
      userState.slabs[slabName] = userState.slabs[slabName] || []
      if(!userState.slabs[slabName].includes(currentBlock.words[currentIndex].id))
        userState.slabs[slabName].push(currentBlock.words[currentIndex].id)

      // If already in slab previously, move to bar
      for(const [name, arr] of Object.entries(userState.slabs)){
        if(arr.includes(currentBlock.words[currentIndex].id) && name !== slabName){
          // promote to bar
          const barName = `Bar ${new Date().toISOString().slice(0,10)}`
          userState.bars[barName] = userState.bars[barName] || []
          if(!userState.bars[barName].includes(currentBlock.words[currentIndex].id))
            userState.bars[barName].push(currentBlock.words[currentIndex].id)
        }
      }

      await saveUserState()
      // automatically proceed next after short delay
      setTimeout(()=> moveNext(false), 1200)
    }

    renderBlocksGrid(); renderSpecialDecks(); updateUserScoreUI();
  }

  function showFeedback(isCorrect, text){
    const f = document.getElementById('feedback')
    f.innerHTML = ''
    const el = document.createElement('div')
    el.className = isCorrect ? 'text-green-400 font-semibold' : 'text-yellow-300'
    el.textContent = text
    f.appendChild(el)

    // After answer: show action buttons
    const actions = document.createElement('div')
    actions.className = 'mt-3 flex gap-2'
    const addBtn = document.createElement('button')
    addBtn.className = 'glass px-3 py-2 rounded-lg btn-anim'
    addBtn.textContent = 'অনুশীলন করুন'
    addBtn.onclick = ()=> { addToPracticeList(currentBlock.words[currentIndex]); showToast('Added to practice list') }

    const delBtn = document.createElement('button')
    delBtn.className = 'glass px-3 py-2 rounded-lg btn-anim'
    delBtn.textContent = 'শব্দ মুছুন'
    delBtn.onclick = ()=> { deleteWord(currentBlock.words[currentIndex].id); showToast('শব্দ মুছে দেওয়া হয়েছে') }

    actions.appendChild(addBtn)
    actions.appendChild(delBtn)
    f.appendChild(actions)
  }

  function addToPracticeList(wordObj){
    const listName = 'My Practice'
    userState.practiceLists[listName] = userState.practiceLists[listName] || []
    if(!userState.practiceLists[listName].includes(wordObj.id)) userState.practiceLists[listName].push(wordObj.id)
    saveUserState()
    renderSpecialDecks()
  }

  function deleteWord(id){
    if(!userState.deletedWords.includes(id)) userState.deletedWords.push(id)
    saveUserState()
    buildBlocks()
    renderBlocksGrid()
    // if deleted from current block, move to next
    moveNext(true)
  }

  function moveNext(jumped=false){
    currentIndex++
    if(currentIndex >= currentBlock.words.length){
      showToast('ডেক শেষ — মেনুতে ফিরুন')
      document.getElementById('practiceScreen').classList.add('hidden')
      document.getElementById('mainMenu').classList.remove('hidden')
      currentBlock = null
      return
    }
    updatePracticeUI()
  }

  // -------------------------------
  // Helpers: UI buttons wiring
  // -------------------------------
  function wireUI(){
    document.getElementById('addWordBtn').addEventListener('click', async ()=>{
      const txt = prompt('নতুন শব্দ লিখুন (বাংলা):')
      if(txt && txt.trim()){
        const newObj = { word: txt.trim(), id: makeId() }
        MASTER_WORDS.push(newObj)
        buildBlocks(); renderBlocksGrid(); await saveUserState()
      }
    })

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(confirm('আপনি কি নিশ্চিত? সব অগ্রগতি রিসেট করা হবে।')){
        userState = { uid: userState.uid, totalPoints:0, deletedWords:[], slabs:{}, bars:{}, practiceLists:{}, stats:{answered:0,correct:0,wrong:0} }
        saveUserState(); buildBlocks(); renderBlocksGrid(); renderSpecialDecks(); updateUserScoreUI(); showToast('প্রগেস রিসেট হয়েছে')
      }
    })

    document.getElementById('backToMenu').addEventListener('click', ()=>{
      document.getElementById('practiceScreen').classList.add('hidden')
      document.getElementById('mainMenu').classList.remove('hidden')
    })

    document.getElementById('speakBtn').addEventListener('click', ()=>{
      const toSpeak = revealCurrentWord() || ''
      speakWord(toSpeak)
    })

    document.getElementById('skipBtn').addEventListener('click', ()=>{
      moveNext(true)
    })

    document.getElementById('answerInput').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') handleAnswer()
    })

    document.getElementById('addToPractice').addEventListener('click', ()=>{
      addToPracticeList(currentBlock.words[currentIndex])
      showToast('Added to practice list')
    })

    document.getElementById('deleteWordBtn').addEventListener('click', ()=>{
      deleteWord(currentBlock.words[currentIndex].id)
    })
  }

  function updateUserScoreUI(){
    document.getElementById('userScore').querySelector('.text-xl').textContent = userState.totalPoints || 0
    document.getElementById('totalAnswered').textContent = userState.stats.answered || 0
    document.getElementById('totalCorrect').textContent = userState.stats.correct || 0
    document.getElementById('totalWrong').textContent = userState.stats.wrong || 0
  }

  // -------------------------------
  // Speech
  // -------------------------------
  function speakWord(text){
    if(!text) return
    try{
      const ut = new SpeechSynthesisUtterance(text)
      ut.lang = 'bn-BD'
      ut.rate = 0.9
      window.speechSynthesis.speak(ut)
    }catch(e){
      console.warn('Speech failed', e)
      showToast('বক্তৃতা (TTS) সমর্থিত নয় আপনার ব্রাউজারে।')
    }
  }

  // -------------------------------
  // App initialization
  // -------------------------------
  async function initApp(){
    // Normalize existing backend data (if any)
    // If some previous userState came from firestore and contains word ids we must ensure MASTER_WORDS contain them
    // Normalize MASTER_WORDS
    MASTER_WORDS = normalizeWords(MASTER_WORDS)

    // Initialize firebase in background, but don't block UI
    initFirebase()

    buildBlocks()
    renderBlocksGrid()
    renderSpecialDecks()
    wireUI()
    updateUserScoreUI()

    // show small hint
    showToast('তৈরি! ব্লক বেছে অনুশীলন শুরু করুন')
  }

  // -------------------------------
  // Expose small helpers to console for debugging
  // -------------------------------
  window.__app = {
    get state(){return {MASTER_WORDS, blocks, userState, currentBlock}}
  }

  </script>
</body>
</html>
